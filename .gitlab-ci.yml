image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]

variables:
    DOCKER_IMAGE_TAG: $CI_COMMIT_REF_SLUG

cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
        - node_modules/
        - dist/

stages:
    - before_build
    # - test
    - build

before_build:
    stage: before_build
    image: node:latest
    script:
        - apk add --update python3 py3-pip ffmpeg
        - python3 --version
        - pip3 --version
        - ffmpeg -version
        - npm ci
        - npm install --only=dev
        - npm run build
    artifacts:
        paths:
            - dist/
    only:
        - main
        # - twitch-event-sub

# test:
#   stage: test
#   image: node:16
#   script:
#     - npm ci
#     - export NODE_ENV="testing"
#     - npm run test

build:
    stage: build
    script:
        - /kaniko/executor
          --context "${CI_PROJECT_DIR}"
          --dockerfile "${CI_PROJECT_DIR}/Dockerfile"
          --cache=true
          --cache-dir="/cache"
          --destination "${CI_REGISTRY_IMAGE}:${DOCKER_IMAGE_TAG}"
    only:
        - main
        # - twitch-event-sub
